# 系统架构文档

## 整体架构

日志风险检测与自动修复系统采用模块化设计，支持流式处理和实时响应。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   多源日志输入   │───▶│   解析与标准化   │───▶│    威胁检测     │
│  Nginx/Apache   │    │   Parser +      │    │  Rules + ML +   │
│  JSON/Database  │    │   Normalizer    │    │   Anomaly       │
│  Container/云审计│    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   输出与审计     │◀───│   自动处置       │◀───│   事件关联       │
│ signals.jsonl   │    │  Action Bus     │    │  Correlator     │
│ actions.jsonl   │    │                 │    │                 │
│ metrics.json    │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 核心模块

### 1. 配置管理 (config.py)
- **职责**: 统一配置管理，支持热加载
- **特性**: YAML/JSON格式支持、线程安全、运行时更新

### 2. 日志解析器 (parser.py)
- **职责**: 多源日志解析与预处理
- **支持**: Nginx/Apache、JSON、数据库、容器、云审计日志
- **鲁棒性**: .gz解压、异常编码、超长行处理

### 3. 标准化器 (normalizer.py)
- **职责**: 日志标准化与安全解码
- **功能**: 多轮解码、SQL注释去除、敏感信息脱敏

### 4. 威胁检测器 (detector.py)
- **职责**: 多策略威胁检测
- **方法**: 规则检测、机器学习、异常检测
- **类型**: SQL注入、XSS、命令注入、敏感信息泄露等

### 5. 事件关联器 (correlator.py)
- **职责**: 跨事件关联与升级
- **功能**: 滑动窗口、去重抑制、严重级别升级

### 6. 自动响应器 (responder.py)
- **职责**: 自动处置动作执行
- **动作**: IP封禁、流量限速、令牌吊销、日志脱敏

## 错误处理策略

### 1. 解析错误
- 容错继续，记录错误日志
- 跳过无法解析的行，不中断流程

### 2. 检测错误
- 降级处理，禁用故障组件
- 记录错误并继续其他检测方法

### 3. 动作执行错误
- 重试机制(最多3次)
- 失败记录到actions.jsonl

## 限流策略

### 1. 输入限流
- 最大行长度限制(1MB)
- 处理速率限制(10k行/秒)
- 内存使用监控(600MB峰值)

### 2. 输出限流
- 信号去重抑制
- TTL缓存管理
- 批量写入优化

### 3. 资源保护
- 线程池大小限制
- 内存泄漏防护
- 超时机制