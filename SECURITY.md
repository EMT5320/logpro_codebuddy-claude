# 安全防护文档

## 反绕过机制

### 1. 多轮解码防护
- **URL编码**: 支持多层嵌套解码
- **HTML实体**: 处理命名和数字实体
- **十六进制**: \x格式字符解码
- **Unicode**: \u格式字符解码
- **Base64**: 安全的Base64解码(防爆炸)

### 2. SQL注释处理
```python
# 支持的注释格式
/* 块注释 */
-- 行注释
# MySQL注释
```

### 3. 大小写混淆
- 规则使用`re.IGNORECASE`标志
- 标准化前统一转换为小写
- 保留原始大小写用于审计

### 4. 空白字符标准化
- 多个空白字符合并为单个空格
- 制表符、换行符统一处理
- 零宽字符过滤

## 输入限制

### 1. 行长度限制
- **最大长度**: 1MB (1,048,576字节)
- **处理策略**: 超长行截断并记录警告
- **安全考虑**: 防止内存耗尽攻击

### 2. 解码轮次限制
- **最大轮次**: 5轮
- **防护目标**: 防止解码炸弹攻击
- **检测机制**: 轮次间内容变化检测

### 3. 文件大小限制
- **单文件**: 建议不超过1GB
- **压缩文件**: 支持.gz格式，自动检测压缩比
- **内存保护**: 流式处理，避免全量加载

## 资源保护

### 1. 内存限制
- **峰值限制**: 600MB
- **监控机制**: 实时内存使用监控
- **保护策略**: 超限时触发垃圾回收

### 2. CPU保护
- **并发限制**: 最大4个工作线程
- **处理速率**: 10,000行/秒上限
- **超时机制**: 单行处理超时5秒

### 3. 磁盘保护
- **输出限制**: 自动轮转日志文件
- **临时文件**: 及时清理临时文件
- **空间检查**: 磁盘空间不足时告警

## DoS防护

### 1. 输入验证
```python
# 恶意输入检测
if len(line) > MAX_LINE_LENGTH:
    line = line[:MAX_LINE_LENGTH]
    logger.warning("行长度超限，已截断")

# 编码炸弹检测
if decode_rounds > MAX_DECODE_ROUNDS:
    logger.warning("解码轮次超限，停止解码")
    break
```

### 2. 速率限制
- **全局限速**: 10k行/秒
- **IP限速**: 单IP 1k行/秒
- **租户限速**: 单租户 5k行/秒

### 3. 资源监控
```python
# 内存监控
memory_usage = psutil.Process().memory_info().rss / 1024 / 1024
if memory_usage > MEMORY_LIMIT_MB:
    logger.error("内存使用超限")
    # 触发保护机制
```

## 数据安全

### 1. 敏感信息脱敏
- **邮箱**: user@domain.com → ***@***.***
- **手机**: 13812345678 → ***-****-****
- **身份证**: 110101199001011234 → ****-**-**-****
- **API密钥**: sk-abc123... → ***MASKED***

### 2. 日志安全
- **审计日志**: 所有操作记录到审计日志
- **访问控制**: 敏感文件权限控制
- **传输加密**: API接口支持HTTPS

### 3. 配置安全
- **密钥管理**: 敏感配置外部化
- **权限最小化**: 运行时最小权限
- **配置验证**: 启动时配置合法性检查

## 安全配置建议

### 1. 生产环境配置
```yaml
system:
  max_line_length: 1048576
  max_decode_rounds: 3  # 生产环境建议降低
  rate_limit: 5000      # 生产环境建议降低

actions:
  dry_run: false        # 生产环境启用实际动作
  
logging:
  level: "WARN"         # 生产环境减少日志输出
```

### 2. 网络安全
- **防火墙**: 限制API端口访问
- **认证**: 启用API认证机制
- **监控**: 异常访问模式检测

### 3. 运维安全
- **定期更新**: 及时更新依赖包
- **备份**: 重要配置和模型备份
- **监控**: 系统资源和安全事件监控